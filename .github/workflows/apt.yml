name: APT REPO in Pages
on:
  push:
    branches:
      - master
      - main

env:
  DIST: pages
  MORE: --keepunusednewfiles
  LOCAL_KEY: 'true'
  PUB_KEY: pub.key
  PRIV_KEY: priv.key
  KEY_ID: 7E1D5D0188BFB69346C6332659CEA38B2E8E4EBE

jobs:
  reprepro:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.1

      - name: Install reprepro and OpenGPG
        run : |
          sudo apt update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt install -y reprepro* rng-tools gpg*
          echo "::set-env name=WORKDIR_SH23::$(pwd)"
          echo "$WORKDIR_SH23"

      - name: GPG key create
        uses: Sirherobrine23/ssh-connect-for-apt@main
        if: env.LOCAL_KEY == 'false'

      - name: import gpg keys
        if: env.LOCAL_KEY == 'true'
        run: |
          gpg --passphrase "${{ secrets.PASSWORD }}" --no-tty --batch --yes --import "$WORKDIR_SH23/keys/$PRIV_KEY"
          echo "" 
          gpg --import "$WORKDIR_SH23/keys/$PUB_KEY"
          echo "default-key $KEY_ID" >> ~/.gnupg/gpg.conf

      - name: list publish_dir
        run: |
          ls "$WORKDIR_SH23/package/main/*.deb"
          ls "$WORKDIR_SH23/package/contrib/*.deb"
          ls "$WORKDIR_SH23/package/non-free/*.deb"

      - name: Reprepro
        run: |
          cd public/
          sudo reprepro $MORE --verbose -C main includedeb $DIST "$WORKDIR_SH23/package/main/*.deb"
          sudo reprepro $MORE --verbose -C contrib includedeb $DIST "$WORKDIR_SH23/package/contrib/*.deb"
          sudo reprepro $MORE --verbose -C non-free includedeb $DIST "$WORKDIR_SH23/package/non-free/*.deb"
          gpg --armor --output "pub.key" --export $KEY_ID
          # bash start.sh

      - name: removendo algumas pastas
        run: |
          cd public/
          sudo rm -r db/
          sudo rm -r conf/
          
      - name: Deploy repository
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.SECRETS }}
          publish_dir: ${{ env.WORKDIR_SH23 }}/public